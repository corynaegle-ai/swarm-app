# Swarm Platform - Alertmanager Configuration
# Location: /etc/alertmanager/alertmanager.yaml
# 
# Reference: /opt/swarm-specs/design-docs/observability/design.md
# Created: 2025-12-15

global:
  # SMTP configuration for email alerts
  smtp_smarthost: 'smtp.gmail.com:587'
  smtp_from: 'alerts@swarmstack.net'
  smtp_auth_username: '${SMTP_USERNAME}'
  smtp_auth_password: '${SMTP_PASSWORD}'
  
  # Slack webhook URL (from environment)
  slack_api_url: '${SLACK_WEBHOOK_URL}'

  # Default resolve timeout
  resolve_timeout: 5m

# Route tree for alert routing
route:
  # Default receiver for unmatched alerts
  receiver: 'slack-notifications'
  
  # Group alerts by these labels
  group_by: ['alertname', 'severity', 'team']
  
  # Wait before sending first notification for a group
  group_wait: 30s
  
  # Wait before sending updated notification
  group_interval: 5m
  
  # Minimum interval between notifications for same group
  repeat_interval: 4h
  
  # Child routes for specific routing
  routes:
    # Critical alerts go to PagerDuty immediately
    - match:
        severity: critical
      receiver: 'pagerduty-critical'
      group_wait: 0s
      repeat_interval: 1h
      continue: true  # Also send to slack
    
    # Critical alerts also go to Slack #critical channel
    - match:
        severity: critical
      receiver: 'slack-critical'
      group_wait: 0s
    
    # Infrastructure team alerts
    - match:
        team: infrastructure
      receiver: 'slack-infrastructure'
    
    # Engineering team alerts  
    - match:
        team: engineering
      receiver: 'slack-engineering'
    
    # Platform team alerts (default fallback)
    - match:
        team: platform
      receiver: 'slack-notifications'

# Inhibition rules - suppress notifications
inhibit_rules:
  # If no VMs are active, suppress VM-specific alerts
  - source_match:
      alertname: SwarmNoActiveVMs
    target_match_re:
      alertname: SwarmVM.*
    equal: []
  
  # If Claude API is down, suppress agent alerts
  - source_match:
      alertname: SwarmClaudeAPIDown
    target_match_re:
      alertname: Swarm(Agent|Ticket).*
    equal: []
  
  # Critical alerts suppress related warnings
  - source_match:
      severity: critical
    target_match:
      severity: warning
    equal: ['alertname']

# Receivers define notification channels
receivers:
  # Default Slack channel
  - name: 'slack-notifications'
    slack_configs:
      - channel: '#swarm-alerts'
        send_resolved: true
        title: '{{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        color: '{{ template "slack.color" . }}'

  # Critical alerts - immediate attention
  - name: 'slack-critical'
    slack_configs:
      - channel: '#swarm-critical'
        send_resolved: true
        title: 'ðŸš¨ CRITICAL: {{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        color: 'danger'

  # Infrastructure team
  - name: 'slack-infrastructure'
    slack_configs:
      - channel: '#swarm-infrastructure'
        send_resolved: true
        title: '{{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        color: '{{ template "slack.color" . }}'

  # Engineering team
  - name: 'slack-engineering'
    slack_configs:
      - channel: '#swarm-engineering'
        send_resolved: true
        title: '{{ template "slack.title" . }}'
        text: '{{ template "slack.text" . }}'
        color: '{{ template "slack.color" . }}'

  # PagerDuty for critical on-call
  - name: 'pagerduty-critical'
    pagerduty_configs:
      - service_key: '${PAGERDUTY_SERVICE_KEY}'
        severity: '{{ if eq .Status "firing" }}critical{{ else }}info{{ end }}'
        description: '{{ .CommonAnnotations.summary }}'
        details:
          alert: '{{ .CommonLabels.alertname }}'
          description: '{{ .CommonAnnotations.description }}'
          runbook: '{{ .CommonAnnotations.runbook }}'

# Templates for notification formatting
templates:
  - '/etc/alertmanager/templates/*.tmpl'
