# MCP Factory - Remaining Steps (3-5)

## Context

Steps 1-2 complete:
- **Parser** (`/opt/mcp-factory/src/parser.js`) - NL → structured JSON spec via Claude
- **Generator** (`/opt/mcp-factory/src/generator.js`) - Spec → TypeScript MCP server package

## Step 3: Validator

Create `/opt/mcp-factory/src/validator.js`

### Requirements

1. **TypeScript Compilation Check**
   ```bash
   cd <generated-server> && npx tsc --noEmit
   ```
   - Parse tsc output for errors
   - Return structured error list with file/line/message

2. **ESLint Check** (optional, skip if no eslint config)
   ```bash
   npx eslint src/ --format json
   ```

3. **MCP Protocol Compliance**
   - Verify `ListToolsRequestSchema` handler exists
   - Verify `CallToolRequestSchema` handler exists
   - Check tool names match between list and switch statement
   - Validate inputSchema structure for each tool

4. **Dependency Check**
   - Verify package.json has required deps (@modelcontextprotocol/sdk, zod)
   - Check node version compatibility

### Interface

```javascript
class MCPValidator {
  async validate(serverDir) → { valid: boolean, errors: [], warnings: [] }
  async checkTypeScript(serverDir) → { success, errors }
  async checkProtocol(serverDir) → { compliant, issues }
}
```

### Output Format

```json
{
  "valid": false,
  "errors": [
    { "type": "typescript", "file": "src/index.ts", "line": 42, "message": "..." },
    { "type": "protocol", "issue": "Missing tool handler for 'search'" }
  ],
  "warnings": [
    { "type": "lint", "file": "src/client.ts", "message": "..." }
  ]
}
```

---

## Step 4: Packager

Create `/opt/mcp-factory/src/packager.js`

### Requirements

1. **Build TypeScript**
   ```bash
   cd <server> && npm install && npm run build
   ```

2. **Create Distribution Package**
   - Copy dist/, package.json, README.md to output
   - Generate .tgz via `npm pack`

3. **Docker Image** (optional flag)
   ```bash
   docker build -t mcp-<name>:<version> .
   ```

4. **Claude Desktop Config**
   - Already generated by generator
   - Packager should resolve absolute paths

5. **Output Manifest**
   ```json
   {
     "name": "mcp-weather",
     "version": "1.0.0",
     "package": "/opt/mcp-factory/output/mcp-weather-1.0.0.tgz",
     "docker": "mcp-weather:1.0.0",
     "claude_config": { ... }
   }
   ```

### Interface

```javascript
class MCPPackager {
  async package(serverDir, options) → { manifest }
  async build(serverDir) → { success, outputDir }
  async createTarball(serverDir) → { tarballPath }
  async buildDocker(serverDir) → { imageName }
}
```

---

## Step 5: Registry

Create `/opt/mcp-factory/src/registry.js`

### Requirements

1. **SQLite Storage** at `/opt/mcp-factory/registry.db`
   ```sql
   CREATE TABLE mcp_servers (
     id TEXT PRIMARY KEY,
     name TEXT UNIQUE,
     version TEXT,
     description TEXT,
     spec JSON,
     package_path TEXT,
     docker_image TEXT,
     claude_config JSON,
     created_at DATETIME DEFAULT CURRENT_TIMESTAMP,
     updated_at DATETIME
   );
   ```

2. **CRUD Operations**
   - `register(manifest)` - Add/update server in registry
   - `get(name)` - Get server by name
   - `list()` - List all registered servers
   - `remove(name)` - Delete server entry

3. **Version Management**
   - Store multiple versions per server
   - Track latest version

### Interface

```javascript
class MCPRegistry {
  constructor(dbPath)
  async init() - Create tables if not exist
  async register(manifest) → { id }
  async get(name, version?) → server | null
  async list(filter?) → servers[]
  async remove(name) → { removed: boolean }
}
```

---

## Step 6: API Server (Bonus)

Create `/opt/mcp-factory/src/index.js` - Express API

### Endpoints

```
POST /api/generate
  Body: { description: string, runtime?: string }
  → { job_id, status: "processing" }

GET /api/jobs/:id
  → { status, result?, errors? }

GET /api/servers
  → { servers: [...] }

GET /api/servers/:name
  → { server details + claude_config }

POST /api/validate
  Body: { spec: object }
  → { valid, errors, warnings }
```

### Job Processing

- Parse description → spec
- Generate server code
- Validate
- Package
- Register
- Return result

---

## Execution Order

```bash
# Step 3
node src/validator.js /opt/mcp-factory/output/mcp-weather

# Step 4  
node src/packager.js /opt/mcp-factory/output/mcp-weather

# Step 5
node src/registry.js register /opt/mcp-factory/output/mcp-weather/manifest.json

# Step 6 (API)
node src/index.js  # Start on port 8081
```

## Success Criteria

- [ ] Validator catches TypeScript errors before packaging
- [ ] Packager produces installable .tgz
- [ ] Registry stores and retrieves server configs
- [ ] Full pipeline: description → registered MCP server < 60s
