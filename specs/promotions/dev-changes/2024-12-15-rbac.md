# PROM-002: RBAC System

**Date:** 2024-12-15  
**Author:** Claude + Neural  
**Session:** Dev Environment RBAC Implementation

## Context

Implementation of role-based access control (RBAC) for the Swarm platform to support multi-tenant environments and proper permission management.

## Architecture

### Role Hierarchy

| Role | Level | Description |
|------|-------|-------------|
| super_admin | 100 | Full system access, can manage other admins |
| admin | 75 | Can approve deployments, manage features |
| developer | 50 | Can create projects, access dev environment |
| viewer | 25 | Read-only dashboard access |

### Permission Categories

- **features**: create_swarm_feature, approve_promotion, initiate_rollback, view_features, access_clarifier
- **users**: manage_users, assign_roles, view_users
- **projects**: create_project, view_projects, manage_tickets
- **system**: view_vms, manage_vms, view_agents, manage_secrets, view_dashboard
- **dev**: access_dev

### Permission Assignments

| Role | Permissions Count |
|------|-------------------|
| super_admin | 17 (all) |
| admin | 15 (excludes manage_users, assign_roles) |
| developer | 9 (view + create project + access dev) |
| viewer | 5 (view only) |

## Database Schema

### Tables Created

1. **roles** - id, name, level, description, created_at
2. **permissions** - id, name, description, category, created_at
3. **role_permissions** - role_id, permission_id, created_at (junction)

### Indexes

- idx_role_permissions_role
- idx_role_permissions_perm
- idx_permissions_category

## Middleware API

```javascript
const { requirePermission, requireLevel, hasPermission } = require('./middleware/rbac');

// Require specific permission
router.post('/feature', requirePermission('create_swarm_feature'), handler);

// Require minimum level
router.get('/admin', requireLevel(75), handler);

// Check permission in handler
if (await hasPermission(req.user, 'approve_promotion')) { ... }
```

## API Changes

### GET /api/auth/me Response

Now includes:
- role_id
- role_name
- role_level
- permissions (array of permission names)

## Testing Verification

- [x] super_admin gets 17 permissions
- [x] developer gets 9 permissions
- [x] /me endpoint returns permissions array
- [x] Role hierarchy levels working (100/75/50/25)

## Production Considerations

1. Run schema migration before deploying code changes
2. Update existing users with appropriate role_id values
3. Test permission-protected routes after deployment
